# Этап 1: Анализ и проектирование - Результаты

## Шаг 1.1: Анализ текущей архитектуры ✅

### Текущая структура Frontend (`app/page.js`)

**Состояние компонента:**
- `url` - URL статьи (string)
- `result` - результат обработки (string)
- `loading` - состояние загрузки (boolean)

**Функция `handleAction`:**
```javascript
async function handleAction(actionType) {
  1. Проверка наличия URL
  2. Парсинг статьи через /api/parse
  3. Перевод через /api/translate
  4. Вывод перевода в результат
}
```

**Проблема:** Все три кнопки передают разные `actionType`, но выполняют одинаковое действие (перевод).

**Точки интеграции:**
- После парсинга статьи (строка 33: `parsedData`)
- Вместо вызова `/api/translate` (строки 36-48)
- Нужно заменить на вызов `/api/ai-action` с передачей `actionType`

### Текущая структура Backend API

**Существующие Endpoints:**

1. **`/api/parse`** (`app/api/parse/route.js`)
   - Метод: `POST`
   - Вход: `{ url: string }`
   - Выход: `{ date, title, content }`
   - Функция: Парсинг HTML статьи, извлечение данных

2. **`/api/translate`** (`app/api/translate/route.js`)
   - Метод: `POST`
   - Вход: `{ content: string }`
   - Выход: `{ translation: string }`
   - Функция: Перевод контента через OpenRouter AI
   - Модель: `deepseek/deepseek-chat`

**Паттерн работы с OpenRouter:**
- Получение API ключа из `process.env.OPENROUTER_API_KEY`
- Базовый URL: `process.env.OPENAI_BASE_URL` или дефолт `https://openrouter.ai/api/v1`
- Endpoint: `/chat/completions`
- Заголовки: `Authorization`, `HTTP-Referer`, `X-Title`
- Формат запроса: `{ model, messages: [{ role, content }] }`

---

## Шаг 1.2: Проектирование API Endpoint ✅

### Новый Endpoint: `/api/ai-action`

**Файл:** `app/api/ai-action/route.js`

**Метод:** `POST`

**Входные параметры:**
```json
{
  "actionType": "О чем статья?" | "Тезисы" | "Пост для Telegram",
  "content": "текст статьи для обработки (string)"
}
```

**Валидация входных данных:**
- `actionType` - обязательное поле, должно быть одним из трёх значений
- `content` - обязательное поле, не должно быть пустым

**Выходные данные (успех):**
```json
{
  "result": "результат обработки AI (string)"
}
```

**Выходные данные (ошибка):**
```json
{
  "error": "описание ошибки (string)"
}
```

**HTTP статусы:**
- `200` - успешная обработка
- `400` - ошибка валидации входных данных
- `500` - ошибка сервера или API OpenRouter

**Архитектура обработки:**
1. Валидация входных параметров
2. Определение промпта по `actionType`
3. Формирование запроса к OpenRouter API
4. Обработка ответа от OpenRouter
5. Возврат результата клиенту

---

## Шаг 1.3: Определение промптов для каждого действия ✅

### Промпт для "О чем статья?"

**System message:**
```
Ты эксперт по анализу текстов. Дай краткое описание статьи на русском языке (2-3 предложения). Опиши основную тему и ключевые моменты.
```

**User message:**
```
О чем эта статья?

[контент статьи]
```

**Ожидаемый результат:**
- Краткое описание (2-3 предложения)
- Основная тема статьи
- Ключевые моменты
- На русском языке

---

### Промпт для "Тезисы"

**System message:**
```
Ты эксперт по анализу текстов. Выдели основные тезисы статьи на русском языке в виде нумерованного списка. Каждый тезис должен быть кратким и содержательным.
```

**User message:**
```
Выдели основные тезисы этой статьи:

[контент статьи]
```

**Ожидаемый результат:**
- Нумерованный список тезисов
- Каждый тезис - краткое утверждение
- Основные идеи статьи
- На русском языке

---

### Промпт для "Пост для Telegram"

**System message:**
```
Ты эксперт по созданию постов для Telegram. Создай интересный пост на русском языке на основе статьи. Используй эмодзи, хештеги и форматирование (жирный текст **текст**, списки). Пост должен быть привлекательным и информативным.
```

**User message:**
```
Создай пост для Telegram на основе этой статьи:

[контент статьи]
```

**Ожидаемый результат:**
- Заголовок с эмодзи
- Основной текст с форматированием
- Хештеги в конце
- Привлекательный и информативный формат
- На русском языке

---

## Структура промптов в коде

```javascript
const prompts = {
  'О чем статья?': {
    system: 'Ты эксперт по анализу текстов. Дай краткое описание статьи на русском языке (2-3 предложения). Опиши основную тему и ключевые моменты.',
    user: (content) => `О чем эта статья?\n\n${content}`
  },
  'Тезисы': {
    system: 'Ты эксперт по анализу текстов. Выдели основные тезисы статьи на русском языке в виде нумерованного списка. Каждый тезис должен быть кратким и содержательным.',
    user: (content) => `Выдели основные тезисы этой статьи:\n\n${content}`
  },
  'Пост для Telegram': {
    system: 'Ты эксперт по созданию постов для Telegram. Создай интересный пост на русском языке на основе статьи. Используй эмодзи, хештеги и форматирование (жирный текст **текст**, списки). Пост должен быть привлекательным и информативным.',
    user: (content) => `Создай пост для Telegram на основе этой статьи:\n\n${content}`
  }
}
```

---

## План интеграции

### Изменения в `app/page.js`:

**Текущий код (строки 35-51):**
```javascript
// Переводим статью через OpenRouter
const translateResponse = await fetch('/api/translate', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ content: parsedData.content }),
})
const translateData = await translateResponse.json()
setResult(translateData.translation || 'Перевод не получен')
```

**Новый код:**
```javascript
// Обрабатываем статью через AI в зависимости от действия
const aiResponse = await fetch('/api/ai-action', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ 
    actionType: actionType,  // 'О чем статья?', 'Тезисы', 'Пост для Telegram'
    content: parsedData.content 
  }),
})
const aiData = await aiResponse.json()
setResult(aiData.result || 'Результат не получен')
```

---

## Выводы Этапа 1

✅ **Анализ завершён:**
- Изучена текущая архитектура Frontend и Backend
- Определены точки интеграции нового функционала
- Понятна структура существующих API routes

✅ **Проектирование завершено:**
- Спроектирован новый Endpoint `/api/ai-action`
- Определены входные и выходные параметры
- Определены HTTP статусы и обработка ошибок

✅ **Промпты определены:**
- Созданы промпты для всех трёх действий
- Промпты оптимизированы для получения нужного результата
- Определена структура хранения промптов в коде

**Готовность к Этапу 2:** ✅ Готово к разработке Backend API
